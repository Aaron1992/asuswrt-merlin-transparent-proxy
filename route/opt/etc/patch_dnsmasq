#!/bin/sh

if [ -d /opt/etc/dnsmasq.d ]; then
    # 为默认的 /etc/dnsmasq.conf 新增配置.
    fgrep -qs 'conf-dir=/opt/etc/dnsmasq.d/,*.conf' /etc/dnsmasq.conf || echo 'conf-dir=/opt/etc/dnsmasq.d/,*.conf' >> /etc/dnsmasq.conf
    resolv_file=$(cat /etc/dnsmasq.conf |grep 'resolv-file=' |tail -n1 |cut -d'=' -f2)
    dnsip=$(cat $resolv_file |head -n1 |cut -d' ' -f2)
    cat /opt/etc/dnsmasq.d/accelerated-domains.china.conf.bak |sed "s#114\.114\.114\.114#${dnsip}#" > /opt/etc/dnsmasq.d/accelerated-domains.china.conf

    dnsmasq --test && kill $(cat /var/run/dnsmasq.pid) && dnsmasq --log-async
fi
